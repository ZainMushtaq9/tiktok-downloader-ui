<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok AI Profile Downloader</title>

<style>
:root {
  --neon: #00ffcc;
  --bg: #0b0f14;
  --panel: #121826;
}

body {
  background: radial-gradient(circle at top, #111827, #020617);
  font-family: "Segoe UI", system-ui;
  color: #e5e7eb;
}

.container {
  max-width: 420px;
  margin: 30px auto;
  background: linear-gradient(180deg, #0f172a, #020617);
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 0 30px rgba(0,255,204,.15);
}

h2 {
  text-align: center;
  color: var(--neon);
  text-shadow: 0 0 15px rgba(0,255,204,.6);
}

input, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
}

input {
  background: #020617;
  color: white;
  border: 1px solid #1f2937;
}

button {
  background: linear-gradient(135deg, #00ffcc, #00bfa6);
  color: black;
  font-weight: bold;
  cursor: pointer;
}

button.secondary {
  background: #020617;
  color: var(--neon);
  border: 1px solid var(--neon);
}

.controls {
  display: flex;
  gap: 10px;
}

.progressBox {
  height: 220px;
  border-radius: 12px;
  background: #020617;
  margin-top: 15px;
  position: relative;
  overflow: hidden;
}

.bar {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 0%;
  background: linear-gradient(180deg, #00ffcc, #00bfa6);
  box-shadow: 0 0 25px rgba(0,255,204,.7);
  transition: height .2s ease;
}

.status {
  text-align: center;
  margin-top: 10px;
  font-size: 13px;
  opacity: .9;
}

.footer {
  text-align: center;
  font-size: 11px;
  margin-top: 10px;
  opacity: .6;
}
</style>
</head>

<body>
<div class="container">
  <h2>TikTok AI Downloader</h2>

  <input id="profile" placeholder="TikTok profile URL">

  <button onclick="fetchVideos()">Fetch videos</button>

  <div class="progressBox">
    <div id="bar" class="bar"></div>
  </div>

  <div id="status" class="status">Idle</div>

  <div class="controls">
    <button class="secondary" onclick="pause()">⏸ Pause</button>
    <button class="secondary" onclick="resume()">▶ Resume</button>
  </div>

  <button onclick="startDownload()">Download All</button>

  <div class="footer">
    Browser will ask permission once • Then fully automatic
  </div>
</div>

<script>
const BACKEND = "https://tiktok-downloader-backend-production-ce2b.up.railway.app";

let videos = [];
let queueIndex = 0;
let paused = false;
let fetchingDone = false;

async function fetchVideos() {
  videos = [];
  queueIndex = 0;
  paused = false;
  fetchingDone = false;

  bar.style.height = "0%";
  status.innerText = "Connecting to profile...";

  const res = await fetch(`${BACKEND}/profile/stream`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ profile_url: profile.value })
  });

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";

  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split("\n");
    buffer = lines.pop();

    for (const line of lines) {
      if (!line.trim()) continue;
      const data = JSON.parse(line);

      videos.push(data.url);

      const percent = Math.round((data.current / data.total) * 100);
      bar.style.height = percent + "%";
      status.innerText = `Fetched ${data.current} / ${data.total}`;
    }
  }

  fetchingDone = true;
  status.innerText = `Ready • ${videos.length} videos`;
}

function startDownload() {
  if (!videos.length) {
    alert("No videos fetched");
    return;
  }

  alert("Allow multiple downloads when browser asks.");

  paused = false;
  downloadNext();
}

function pause() {
  paused = true;
  status.innerText = "Paused";
}

function resume() {
  if (!paused) return;
  paused = false;
  status.innerText = "Resuming...";
  downloadNext();
}

function downloadNext() {
  if (paused || queueIndex >= videos.length) {
    if (queueIndex >= videos.length) {
      status.innerText = "All downloads completed";
    }
    return;
  }

  const n = queueIndex + 1;
  status.innerText = `Downloading ${n}.mp4`;

  const a = document.createElement("a");
  a.href = `${BACKEND}/download?url=${encodeURIComponent(videos[queueIndex])}&n=${n}`;
  a.download = `${n}.mp4`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  queueIndex++;

  setTimeout(downloadNext, 800); // safe browser pacing
}
</script>
</body>
</html>
