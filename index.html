<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>TikTok Profile Downloader</title>

<style>
body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: #0b0f1a;
  color: #e6e6e6;
}

.container {
  max-width: 420px;
  margin: 20px auto;
  padding: 16px;
  background: #11162a;
  border-radius: 12px;
  box-shadow: 0 0 30px rgba(0,255,255,0.1);
}

h2 {
  text-align: center;
  margin-bottom: 12px;
  color: #00f7ff;
}

input, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 8px;
  border: none;
  font-size: 15px;
}

input {
  background: #0b1022;
  color: #fff;
  border: 1px solid #1f2a4a;
}

button {
  background: linear-gradient(135deg, #00f7ff, #0066ff);
  color: #000;
  font-weight: 600;
}

button:disabled {
  background: #333;
  color: #777;
}

.progressBox {
  margin-top: 15px;
  height: 240px;
  border-radius: 10px;
  background: #070b18;
  overflow: hidden;
  position: relative;
}

.progressFill {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 0%;
  background: linear-gradient(to top, #00ff88, #00f7ff);
  transition: height 0.2s linear;
}

.status {
  margin-top: 10px;
  text-align: center;
  font-size: 14px;
}

.queue {
  margin-top: 10px;
  font-size: 13px;
  color: #aaa;
  text-align: center;
}
</style>
</head>

<body>

<div class="container">
  <h2>TikTok Profile Downloader</h2>

  <input id="profileUrl" placeholder="Paste TikTok profile URL">

  <button id="fetchBtn" onclick="fetchProfile()">Fetch all videos</button>
  <button id="downloadBtn" onclick="startDownloads()" disabled>Download all videos</button>

  <div class="progressBox">
    <div id="progressFill" class="progressFill"></div>
  </div>

  <div id="status" class="status">Idle</div>
  <div id="queue" class="queue"></div>
</div>

<script>
const BACKEND = "https://tiktok-downloader-backend-production-ce2b.up.railway.app";

let state = {
  videos: [],
  current: 0,
  total: 0,
  failed: []
};

loadState();

function saveState() {
  localStorage.setItem("tiktokQueue", JSON.stringify(state));
}

function loadState() {
  const s = localStorage.getItem("tiktokQueue");
  if (s) state = JSON.parse(s);
}

async function fetchProfile() {
  state = { videos: [], current: 0, total: 0, failed: [] };
  saveState();

  document.getElementById("status").innerText = "Fetching video list...";
  document.getElementById("downloadBtn").disabled = true;

  const res = await fetch(`${BACKEND}/profile/stream`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ profile_url: document.getElementById("profileUrl").value })
  });

  if (!res.ok) {
    document.getElementById("status").innerText = "Failed to fetch profile";
    return;
  }

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";

  while (true) {
    const {value, done} = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, {stream:true});
    const lines = buffer.split("\n");
    buffer = lines.pop();

    for (const line of lines) {
      if (!line.trim()) continue;
      const data = JSON.parse(line);

      state.total = data.total;
      state.videos.push(data.url);
      saveState();

      updateProgress(state.videos.length, state.total);
    }
  }

  document.getElementById("status").innerText = "All videos fetched";
  document.getElementById("downloadBtn").disabled = false;
}

function updateProgress(current, total) {
  const percent = Math.round((current / total) * 100);
  document.getElementById("progressFill").style.height = percent + "%";
  document.getElementById("status").innerText = `Fetched ${current} / ${total}`;
}

async function startDownloads() {
  if (!confirm("Allow multiple downloads when Chrome asks. Continue?")) return;

  document.getElementById("fetchBtn").disabled = true;
  document.getElementById("downloadBtn").disabled = true;

  for (let i = state.current; i < state.videos.length; i++) {
    state.current = i;
    saveState();

    document.getElementById("queue").innerText =
      `Downloading ${i+1} / ${state.videos.length}`;

    try {
      await downloadSingle(state.videos[i], i + 1);
    } catch (e) {
      state.failed.push(i);
    }

    await sleep(900);
  }

  document.getElementById("status").innerText = "Download complete";
  document.getElementById("queue").innerText =
    state.failed.length ? `Failed: ${state.failed.length}` : "All successful";
}

function downloadSingle(url, n) {
  return new Promise(resolve => {
    const a = document.createElement("a");
    a.href = `${BACKEND}/download?url=${encodeURIComponent(url)}&n=${n}`;
    a.download = `${n}.mp4`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(resolve, 3000);
  });
}

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}
</script>

</body>
</html>
