<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TikTok Profile Downloader</title>

<style>
body { font-family: Arial; background:#f4f4f4; }
.container {
  max-width:420px; margin:40px auto;
  background:#fff; padding:20px; border-radius:8px;
}
input, button { width:100%; padding:10px; margin-top:10px; }
#progress {
  height:250px; border:1px solid #ccc; margin-top:15px;
  display:flex; align-items:flex-end;
}
#bar { width:100%; height:0%; background:#28a745; transition:height .2s; }
#status { margin-top:10px; font-size:14px; }
</style>
</head>

<body>
<div class="container">
  <h3>TikTok Profile Downloader</h3>

  <input id="profile" placeholder="TikTok profile URL">
  <button onclick="start()">Fetch all videos from profile</button>

  <div id="progress"><div id="bar"></div></div>
  <div id="status">Idle</div>
</div>

<script>
const BACKEND = "https://tiktok-downloader-backend-production-ce2b.up.railway.app";

async function start() {
  document.getElementById("status").innerText = "Connecting...";
  document.getElementById("bar").style.height = "0%";

  let res;
  try {
    res = await fetch(`${BACKEND}/profile/stream`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        profile_url: document.getElementById("profile").value
      })
    });
  } catch (e) {
    document.getElementById("status").innerText = "Network error";
    return;
  }

  if (!res.ok || !res.body) {
    document.getElementById("status").innerText = "Failed to fetch";
    return;
  }

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";

  while (true) {
    const {value, done} = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, {stream:true});
    const lines = buffer.split("\n");
    buffer = lines.pop();

    for (const line of lines) {
      if (!line.trim()) continue;
      const data = JSON.parse(line);

      if (data.error) {
        document.getElementById("status").innerText = data.error;
        return;
      }

      if (data.current && data.total) {
        const pct = Math.round((data.current/data.total)*100);
        document.getElementById("bar").style.height = pct+"%";
        document.getElementById("status").innerText =
          `Fetched ${data.current} / ${data.total}`;
      }
    }
  }

  document.getElementById("status").innerText = "All videos fetched";
}
</script>
</body>
</html>
