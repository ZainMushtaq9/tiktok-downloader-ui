<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TikTok Profile Downloader</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f7f7f7;
  margin: 0;
  padding: 20px;
}

.container {
  max-width: 600px;
  margin: auto;
  background: #ffffff;
  padding: 20px;
  border-radius: 6px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

h1 {
  margin-top: 0;
  font-size: 22px;
}

input, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  font-size: 16px;
}

button {
  background: #111;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:disabled {
  background: #999;
}

.status {
  margin-top: 15px;
  font-size: 14px;
  color: #333;
}

/* ===== Vertical Progress Bar ===== */
#progressWrapper {
  position: fixed;
  right: 12px;
  top: 80px;
  width: 14px;
  height: 65vh;
  background: #e0e0e0;
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid #ccc;
}

#progressBar {
  width: 100%;
  height: 0%;
  background: linear-gradient(180deg, #4caf50, #81c784);
  transition: height 0.25s ease;
}

/* ===== Video count display ===== */
#count {
  margin-top: 10px;
  font-weight: bold;
}
</style>
</head>

<body>

<div class="container">
  <h1>TikTok Profile Downloader</h1>

  <input
    id="profile"
    placeholder="https://www.tiktok.com/@username"
  />

  <button id="startBtn" onclick="startFetch()">
    Fetch all videos from profile
  </button>

  <div class="status" id="status">
    Idle
  </div>

  <div id="count"></div>
</div>

<!-- Vertical progress bar -->
<div id="progressWrapper">
  <div id="progressBar"></div>
</div>

<script>
const BACKEND = "https://tiktok-downloader-backend-production-ce2b.up.railway.app";

async function startFetch() {
  const profile = document.getElementById("profile").value.trim();
  if (!profile) {
    alert("Please enter a TikTok profile URL");
    return;
  }

  const btn = document.getElementById("startBtn");
  btn.disabled = true;

  document.getElementById("status").textContent = "Connecting to backend…";
  document.getElementById("progressBar").style.height = "0%";
  document.getElementById("count").textContent = "";

  try {
    const response = await fetch(`${BACKEND}/profile/stream`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ profile_url: profile })
    });

    if (!response.ok || !response.body) {
      throw new Error("Backend not responding");
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    let buffer = "";
    let total = 0;
    let current = 0;

    document.getElementById("status").textContent = "Fetching video list…";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split("\n");
      buffer = lines.pop();

      for (const line of lines) {
        if (!line.trim()) continue;

        const data = JSON.parse(line);
        current = data.current;
        total = data.total;

        const percent = Math.floor((current / total) * 100);
        document.getElementById("progressBar").style.height = percent + "%";

        document.getElementById("count").textContent =
          `${current} / ${total} videos discovered`;
      }
    }

    document.getElementById("status").textContent = "All videos fetched ✔";
    btn.disabled = false;

  } catch (err) {
    document.getElementById("status").textContent =
      "Error: " + err.message;
    btn.disabled = false;
  }
}
</script>

</body>
</html>
